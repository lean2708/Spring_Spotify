<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring_spotify</a> &gt; <a href="index.source.html" class="el_package">spotify.spring_spotify.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package spotify.spring_spotify.service;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.multipart.MultipartFile;
import spotify.spring_spotify.dto.basic.PlaylistBasic;
import spotify.spring_spotify.dto.basic.SongBasic;
import spotify.spring_spotify.dto.request.UserRequest;
import spotify.spring_spotify.dto.response.*;
import spotify.spring_spotify.entity.Album;
import spotify.spring_spotify.entity.Playlist;
import spotify.spring_spotify.entity.Role;
import spotify.spring_spotify.entity.User;
import spotify.spring_spotify.exception.ErrorCode;
import spotify.spring_spotify.exception.FileException;
import spotify.spring_spotify.exception.SpotifyException;
import spotify.spring_spotify.mapper.PlaylistMapper;
import spotify.spring_spotify.mapper.RoleMapper;
import spotify.spring_spotify.mapper.UserMapper;
import spotify.spring_spotify.repository.PlaylistRepository;
import spotify.spring_spotify.repository.RoleRepository;
import spotify.spring_spotify.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class UserService {
    private final UserRepository userRepository;
    private final UserMapper userMapper;
    private final PlaylistRepository playlistRepository;
    private final PlaylistMapper playlistMapper;
    private final RoleRepository roleRepository;
    private final RoleMapper roleMapper;
    private final FileService fileService;

    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public UserResponse create(UserRequest request){
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if(userRepository.existsByEmail(request.getEmail())){</span>
<span class="nc" id="L50">            throw new SpotifyException(ErrorCode.USER_EXISTED);</span>
        }

<span class="nc" id="L53">        User user = userMapper.toUser(request);</span>

<span class="nc" id="L55">        PasswordEncoder passwordEncoder = new BCryptPasswordEncoder(10);</span>
<span class="nc" id="L56">        user.setPassword(passwordEncoder.encode(user.getPassword()));</span>

        // playlist
<span class="nc bnc" id="L59" title="All 4 branches missed.">        if(request.getCreatedPlaylists() != null &amp;&amp; !request.getCreatedPlaylists().isEmpty()){</span>
<span class="nc" id="L60">            List&lt;Playlist&gt; playlistList = playlistRepository</span>
<span class="nc" id="L61">                    .findAllByTitleIn(new ArrayList&lt;&gt;(request.getCreatedPlaylists()))</span>
<span class="nc" id="L62">                    .orElseThrow(() -&gt; new SpotifyException(ErrorCode.PLAYLIST_NOT_EXISTED));</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            for(Playlist playlist : playlistList){</span>
<span class="nc" id="L64">                playlist.setListener(playlist.getListener() + 1);</span>
<span class="nc" id="L65">                playlist.setCreator(user.getName());</span>
<span class="nc" id="L66">            }</span>
<span class="nc" id="L67">           user.setCreatedPlaylists(new HashSet&lt;&gt;(playlistList));</span>
<span class="nc" id="L68">        }</span>
        else{
<span class="nc" id="L70">            user.setCreatedPlaylists(new HashSet&lt;&gt;());</span>
        }

<span class="nc bnc" id="L73" title="All 4 branches missed.">        if(request.getRoles() != null &amp;&amp; !request.getRoles().isEmpty()){</span>
<span class="nc" id="L74">            List&lt;Role&gt; roleList = roleRepository</span>
<span class="nc" id="L75">                    .findAllByNameIn(new ArrayList&lt;&gt;(request.getRoles()));</span>
<span class="nc" id="L76">            user.setRoles(new HashSet&lt;&gt;(roleList));</span>
<span class="nc" id="L77">        }</span>
        else{
<span class="nc" id="L79">            Role userRole = roleRepository.findByName(&quot;USER&quot;).orElseThrow(</span>
<span class="nc" id="L80">                    () -&gt; new SpotifyException(ErrorCode.ROLE_NOT_EXISTED));</span>
<span class="nc" id="L81">            Set&lt;Role&gt; roles = new HashSet&lt;&gt;();</span>
<span class="nc" id="L82">            roles.add(userRole);</span>
<span class="nc" id="L83">            user.setRoles(roles);</span>
        }

<span class="nc" id="L86">        return convertUserResponse(userRepository.save(user));</span>
    }
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public UserResponse fetchById(long id){
<span class="nc" id="L90">        User userDB = userRepository.findById(id).</span>
<span class="nc" id="L91">                orElseThrow(() -&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>
<span class="nc" id="L92">        return convertUserResponse(userDB);</span>
    }
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public PageResponse&lt;UserResponse&gt; fetchAllUser(int pageNo,int pageSize, String nameSortOrder){
<span class="nc" id="L96">            pageNo = pageNo - 1;</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">            Sort sort = (nameSortOrder.equalsIgnoreCase(&quot;asc&quot;))</span>
<span class="nc" id="L99">                    ? Sort.by(Sort.Order.asc(&quot;name&quot;))</span>
<span class="nc" id="L100">                    : Sort.by(Sort.Order.desc(&quot;name&quot;));</span>

<span class="nc" id="L102">            Pageable pageable = PageRequest.of(pageNo, pageSize, sort);</span>

<span class="nc" id="L104">            Page&lt;User&gt; userPage = userRepository.findAll(pageable);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (userPage.isEmpty()) {</span>
<span class="nc" id="L106">                throw new SpotifyException(ErrorCode.USER_NOT_FOUND);</span>
            }

<span class="nc" id="L109">            List&lt;UserResponse&gt; responses =  convertListUserResponse(userPage.getContent());</span>

<span class="nc" id="L111">            return PageResponse.&lt;UserResponse&gt;builder()</span>
<span class="nc" id="L112">                    .page(userPage.getNumber() + 1)  // Thêm 1 để bắt đầu từ trang 1</span>
<span class="nc" id="L113">                    .size(userPage.getSize())</span>
<span class="nc" id="L114">                    .totalPages(userPage.getTotalPages())</span>
<span class="nc" id="L115">                    .totalItems(userPage.getTotalElements())</span>
<span class="nc" id="L116">                    .items(responses)</span>
<span class="nc" id="L117">                    .build();</span>
    }

    public List&lt;PlaylistBasic&gt; fetchSavedPlaylists(){
<span class="nc" id="L121">        var context = SecurityContextHolder.getContext();</span>
<span class="nc" id="L122">        String email = context.getAuthentication().getName();</span>

<span class="nc" id="L124">        User user = userRepository.findByEmail(email).orElseThrow(</span>
<span class="nc" id="L125">                () -&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>

<span class="nc" id="L127">        List&lt;Playlist&gt; savedList = playlistRepository.findAllByIdIn(user.getSavedPlaylistId())</span>
<span class="nc" id="L128">                .orElseThrow(() -&gt; new SpotifyException(ErrorCode.PLAYLIST_NOT_EXISTED));</span>

<span class="nc" id="L130">        List&lt;PlaylistBasic&gt; playlistBasics = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        for(Playlist playlist : savedList){</span>
<span class="nc" id="L132">            PlaylistBasic basic = playlistMapper.toPlaylistBasic(playlist);</span>
<span class="nc" id="L133">            playlistBasics.add(basic);</span>
<span class="nc" id="L134">        }</span>
<span class="nc" id="L135">        return playlistBasics;</span>
    }

    public UserResponse update(long id, UserRequest request, MultipartFile multipartFile) throws FileException, IOException {
<span class="nc" id="L139">        User userDB = userRepository.findById(id).</span>
<span class="nc" id="L140">                orElseThrow(() -&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>

<span class="nc bnc" id="L142" title="All 4 branches missed.">        if (userDB.getEmail() != null &amp;&amp; !userDB.getEmail().equals(request.getEmail())) {</span>
<span class="nc" id="L143">            throw new SpotifyException(ErrorCode.EMAIL_IMMUTABLE);</span>
        }
<span class="nc" id="L145">        User user = userMapper.updateUser(userDB,request);</span>

        // playlist
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if(request.getCreatedPlaylists() != null){</span>
<span class="nc" id="L149">            List&lt;Playlist&gt; playlistList = playlistRepository</span>
<span class="nc" id="L150">                    .findAllByTitleIn(new ArrayList&lt;&gt;(request.getCreatedPlaylists()))</span>
<span class="nc" id="L151">                    .orElseThrow(() -&gt; new SpotifyException(ErrorCode.PLAYLIST_NOT_EXISTED));</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            for(Playlist playlist : playlistList){</span>
<span class="nc" id="L153">                playlist.setListener(playlist.getListener() + 1);</span>
<span class="nc" id="L154">                playlist.setCreator(user.getName());</span>
<span class="nc" id="L155">            }</span>
<span class="nc" id="L156">            user.setCreatedPlaylists(new HashSet&lt;&gt;(playlistList));</span>
<span class="nc" id="L157">        }</span>
        else{
<span class="nc" id="L159">            user.setCreatedPlaylists(new HashSet&lt;&gt;());</span>
        }

<span class="nc bnc" id="L162" title="All 4 branches missed.">        if(request.getRoles() != null &amp;&amp; !request.getRoles().isEmpty()){</span>
<span class="nc" id="L163">            List&lt;Role&gt; roleList = roleRepository</span>
<span class="nc" id="L164">                    .findAllByNameIn(new ArrayList&lt;&gt;(request.getRoles()));</span>
<span class="nc" id="L165">            user.setRoles(new HashSet&lt;&gt;(roleList));</span>
        }


<span class="nc bnc" id="L169" title="All 4 branches missed.">        if (multipartFile != null &amp;&amp; !multipartFile.isEmpty()) {</span>
<span class="nc" id="L170">            List&lt;String&gt; allowedFileExtensions = new ArrayList&lt;&gt;</span>
<span class="nc" id="L171">                    (Arrays.asList(&quot;jpg&quot;, &quot;jpeg&quot;, &quot;png&quot;, &quot;gif&quot;, &quot;bmp&quot;,&quot;svg&quot;));</span>
<span class="nc" id="L172">            user.setImageURL(fileService.uploadFile(multipartFile, allowedFileExtensions).getUrl());</span>
        }

<span class="nc" id="L175">        return convertUserResponse(userRepository.save(user));</span>
    }
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public void deleteUser(long id){
<span class="nc" id="L179">        User userDB = userRepository.findById(id).</span>
<span class="nc" id="L180">                orElseThrow(() -&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>

<span class="nc" id="L182">        userRepository.delete(userDB);</span>
<span class="nc" id="L183">    }</span>

    public PlaylistBasic createSavedPlaylists(long id) {
<span class="nc" id="L186">        Playlist playlist = playlistRepository.findById(id)</span>
<span class="nc" id="L187">                .orElseThrow(() -&gt; new SpotifyException(ErrorCode.PLAYLIST_NOT_EXISTED));</span>

<span class="nc" id="L189">        var context = SecurityContextHolder.getContext();</span>
<span class="nc" id="L190">        String email = context.getAuthentication().getName();</span>

<span class="nc" id="L192">        User user = userRepository.findByEmail(email).orElseThrow(</span>
<span class="nc" id="L193">                () -&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>

<span class="nc" id="L195">        List&lt;Long&gt; idList = user.getSavedPlaylistId();</span>
<span class="nc" id="L196">        idList.add(playlist.getId());</span>
<span class="nc" id="L197">        user.setSavedPlaylistId(idList);</span>

<span class="nc" id="L199">        userRepository.save(user);</span>

<span class="nc" id="L201">        return playlistMapper.toPlaylistBasic(playlist);</span>
    }

    public UserResponse convertUserResponse(User user){
<span class="nc" id="L205">        UserResponse response = userMapper.toUserResponse(user);</span>

<span class="nc" id="L207">        Set&lt;PlaylistBasic&gt; playlistBasicSet = user.getCreatedPlaylists()</span>
<span class="nc" id="L208">                .stream().map(playlistMapper::toPlaylistBasic).collect(Collectors.toSet());</span>
<span class="nc" id="L209">        response.setCreatedPlaylists(playlistBasicSet);</span>

<span class="nc" id="L211">        Set&lt;RoleResponse&gt; roleResponses = user.getRoles().stream()</span>
<span class="nc" id="L212">                .map(roleMapper::toRoleResponse).collect(Collectors.toSet());</span>
<span class="nc" id="L213">        response.setRoles(roleResponses);</span>
<span class="nc" id="L214">        return response;</span>
    }

    public List&lt;UserResponse&gt; convertListUserResponse(List&lt;User&gt; userList){
<span class="nc" id="L218">        List&lt;UserResponse&gt; userResponseList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        for(User user : userList){</span>
<span class="nc" id="L220">            UserResponse response = convertUserResponse(user);</span>
<span class="nc" id="L221">            userResponseList.add(response);</span>
<span class="nc" id="L222">        }</span>
<span class="nc" id="L223">        return userResponseList;</span>
    }
    public void removeSavedPlaylist(long playlistId) {
<span class="nc" id="L226">        var context = SecurityContextHolder.getContext();</span>
<span class="nc" id="L227">        String email = context.getAuthentication().getName();</span>

<span class="nc" id="L229">        User user = userRepository.findByEmail(email).orElseThrow(</span>
<span class="nc" id="L230">                () -&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (!user.getSavedPlaylistId().contains(playlistId)) {</span>
<span class="nc" id="L233">            throw new SpotifyException(ErrorCode.PLAYLIST_NOT_IN_USER);</span>
        }

<span class="nc" id="L236">        user.getSavedPlaylistId().remove(playlistId);</span>
<span class="nc" id="L237">        userRepository.save(user);</span>
<span class="nc" id="L238">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring_spotify</a> &gt; <a href="index.source.html" class="el_package">spotify.spring_spotify.service</a> &gt; <span class="el_source">FileService.java</span></div><h1>FileService.java</h1><pre class="source lang-java linenums">package spotify.spring_spotify.service;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.model.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.io.FilenameUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.Resource;
import org.springframework.core.io.UrlResource;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.xml.sax.SAXException;
import spotify.spring_spotify.dto.response.FileResponse;
import spotify.spring_spotify.exception.FileException;
import java.io.*;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.*;
import java.io.File;
import java.io.IOException;
import com.amazonaws.services.s3.model.S3Object;

<span class="fc" id="L24">@Slf4j</span>
@RequiredArgsConstructor
@Service
public class FileService {
    @Value(&quot;${aws.bucket.name}&quot;)
    private String bucketName;

    private final AmazonS3 s3Client;

    public FileResponse uploadFile(MultipartFile multipartFile, List&lt;String&gt; allowedFileExtensions) throws IOException, FileException {
<span class="nc bnc" id="L34" title="All 4 branches missed.">        if (multipartFile == null || multipartFile.isEmpty()) {</span>
<span class="nc" id="L35">            throw new FileException(&quot;File trống. Không thể lưu trữ file&quot;);</span>
        }
<span class="nc" id="L37">        boolean isValidFile = isValidFile(multipartFile);</span>

<span class="nc bnc" id="L39" title="All 4 branches missed.">        if (!isValidFile || !allowedFileExtensions.contains(FilenameUtils.getExtension(multipartFile.getOriginalFilename()))){</span>
<span class="nc" id="L40">            throw new FileException(&quot;File &quot; +  multipartFile.getOriginalFilename() + &quot; không hợp lệ. Định dạng file hoặc tên file không được hỗ trợ.&quot;);</span>
        }

        // convert multipart file  to a file
<span class="nc" id="L44">        File file = new File(System.getProperty(&quot;java.io.tmpdir&quot;), multipartFile.getOriginalFilename());</span>
<span class="nc" id="L45">        try (FileOutputStream fileOutputStream = new FileOutputStream(file)){</span>
<span class="nc" id="L46">            fileOutputStream.write(multipartFile.getBytes());</span>
        }

        // generate file name
<span class="nc" id="L50">        String fileName = generateFileName(multipartFile);</span>
        // upload file
<span class="nc" id="L52">        PutObjectRequest request = new PutObjectRequest(bucketName, fileName, file);</span>
<span class="nc" id="L53">        ObjectMetadata metadata = new ObjectMetadata();</span>
<span class="nc" id="L54">        metadata.setContentType(&quot;plain/&quot;+ FilenameUtils.getExtension(multipartFile.getOriginalFilename()));</span>
<span class="nc" id="L55">        metadata.addUserMetadata(&quot;Title&quot;, &quot;File Upload - &quot; + fileName);</span>
<span class="nc" id="L56">        metadata.setContentLength(file.length());</span>
<span class="nc" id="L57">        request.setMetadata(metadata);</span>
<span class="nc" id="L58">        s3Client.putObject(request);</span>

<span class="nc" id="L60">        String fileUrl = s3Client.getUrl(bucketName, fileName).toString();</span>

        // delete file
<span class="nc" id="L63">        file.delete();</span>

<span class="nc" id="L65">        return FileResponse.builder()</span>
<span class="nc" id="L66">                .fileName(fileName)</span>
<span class="nc" id="L67">                .url(fileUrl)</span>
<span class="nc" id="L68">                .build();</span>
    }


    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('PREMIUM')&quot;)
    public Object downloadFile(String fileName) throws FileException {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (bucketIsEmpty()) {</span>
<span class="nc" id="L75">            throw new FileException(&quot;Bucket yêu cầu không tồn tại hoặc trống.&quot;);</span>
        }
        try {
<span class="nc" id="L78">            S3Object object = s3Client.getObject(bucketName, fileName);</span>

<span class="nc" id="L80">            try (S3ObjectInputStream s3is = object.getObjectContent()) {</span>
<span class="nc" id="L81">                try (FileOutputStream fileOutputStream = new FileOutputStream(fileName)) {</span>
<span class="nc" id="L82">                    byte[] read_buf = new byte[1024];</span>
                    int read_len;
<span class="nc bnc" id="L84" title="All 2 branches missed.">                    while ((read_len = s3is.read(read_buf)) &gt; 0) {</span>
<span class="nc" id="L85">                        fileOutputStream.write(read_buf, 0, read_len);</span>
                    }
                }

<span class="nc" id="L89">                Path pathObject = Paths.get(fileName);</span>
<span class="nc" id="L90">                Resource resource = new UrlResource(pathObject.toUri());</span>

<span class="nc bnc" id="L92" title="All 4 branches missed.">                if (resource.exists() &amp;&amp; resource.isReadable()) {</span>
<span class="nc" id="L93">                    return resource;</span>
                } else {
<span class="nc" id="L95">                    throw new FileException(&quot;Không thể tìm thấy file!&quot;);</span>
                }
            }
<span class="nc" id="L98">        } catch (AmazonS3Exception e) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (e.getErrorCode().equals(&quot;NoSuchKey&quot;)) {</span>
<span class="nc" id="L100">                throw new FileException(&quot;File yêu cầu không tồn tại trong kho lưu trữ.&quot;);</span>
            } else {
<span class="nc" id="L102">                throw new FileException(&quot;Lỗi khi truy cập file trong S3: &quot; + e.getMessage());</span>
            }
<span class="nc" id="L104">        } catch (IOException e) {</span>
<span class="nc" id="L105">            throw new FileException(&quot;Lỗi khi xử lý file: &quot; + e.getMessage());</span>
        }
    }


    public boolean delete(String fileName) {
        try {
<span class="nc" id="L112">            s3Client.deleteObject(bucketName, fileName);</span>
<span class="nc" id="L113">            return true;</span>
<span class="nc" id="L114">        } catch (AmazonS3Exception e) {</span>
<span class="nc" id="L115">            System.out.println(&quot;Lỗi khi xóa file khỏi S3: &quot; + e.getMessage());</span>
<span class="nc" id="L116">            return false;</span>
        }
    }

    private boolean bucketIsEmpty() {
<span class="nc" id="L121">        ListObjectsV2Result result = s3Client.listObjectsV2(this.bucketName);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (result == null){</span>
<span class="nc" id="L123">            return false;</span>
        }
<span class="nc" id="L125">        List&lt;S3ObjectSummary&gt; objects = result.getObjectSummaries();</span>
<span class="nc" id="L126">        return objects.isEmpty();</span>
    }

    private String generateFileName(MultipartFile multiPart) {
<span class="nc" id="L130">        return new Date().getTime() + &quot;-&quot; + multiPart.getOriginalFilename().trim().replaceAll(&quot; &quot;, &quot;_&quot;);</span>
    }
    public boolean isValidFile(MultipartFile multipartFile){
<span class="nc" id="L133">        log.info(&quot;Empty Status ==&gt; {}&quot;, multipartFile.isEmpty());</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (Objects.isNull(multipartFile.getOriginalFilename())){</span>
<span class="nc" id="L135">            return false;</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        return !multipartFile.getOriginalFilename().trim().equals(&quot;&quot;);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring_spotify</a> &gt; <a href="index.source.html" class="el_package">spotify.spring_spotify.service</a> &gt; <span class="el_source">AuthService.java</span></div><h1>AuthService.java</h1><pre class="source lang-java linenums">package spotify.spring_spotify.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Async;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.util.CollectionUtils;
import spotify.spring_spotify.constant.RoleEnum;
import spotify.spring_spotify.dto.basic.PlaylistBasic;
import spotify.spring_spotify.dto.request.*;
import spotify.spring_spotify.dto.response.*;
import spotify.spring_spotify.entity.*;
import spotify.spring_spotify.exception.ErrorCode;
import spotify.spring_spotify.exception.SpotifyException;
import spotify.spring_spotify.mapper.PlaylistMapper;
import spotify.spring_spotify.mapper.RoleMapper;
import spotify.spring_spotify.mapper.UserMapper;
import spotify.spring_spotify.repository.*;
import com.nimbusds.jose.*;
import com.nimbusds.jose.crypto.MACSigner;
import com.nimbusds.jose.crypto.MACVerifier;
import com.nimbusds.jwt.JWTClaimsSet;
import com.nimbusds.jwt.SignedJWT;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.text.ParseException;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;


@RequiredArgsConstructor
@Service
<span class="fc" id="L40">@Slf4j</span>
public class AuthService {

    private final UserRepository userRepository;
    private final UserMapper userMapper;
    private final PlaylistMapper playlistMapper;
    private final EmailService emailService;
    private final RoleRepository roleRepository;
    private final RoleMapper roleMapper;
    private final InvalidatedRepository invalidatedRepository;
    private final AlbumRepository albumRepository;
    private final ArtistRepository artistRepository;
    private final PlaylistRepository playlistRepository;
    private final SongRepository songRepository;

    @Value(&quot;${jwt.signerKey}&quot;)
    protected String SINGER_KEY;
    @Value(&quot;${jwt.validity-in-days}&quot;)
    protected long tokenExpiration;


    public UserResponse register(RegisterRequest request){
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if(userRepository.existsByEmail(request.getEmail())){</span>
<span class="nc" id="L63">            throw new SpotifyException(ErrorCode.EMAIL_EXISTED);</span>
        }

<span class="nc" id="L66">        User user = userMapper.toUserByRegister(request);</span>

<span class="nc" id="L68">        PasswordEncoder passwordEncoder = new BCryptPasswordEncoder(10);</span>
<span class="nc" id="L69">        user.setPassword(passwordEncoder.encode(user.getPassword()));</span>

<span class="nc" id="L71">        Role userRole = roleRepository.findByName(&quot;USER&quot;).orElseThrow(</span>
<span class="nc" id="L72">                () -&gt; new SpotifyException(ErrorCode.ROLE_NOT_EXISTED));</span>
<span class="nc" id="L73">        Set&lt;Role&gt; roles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if(user.getRoles() != null){</span>
<span class="nc" id="L75">            roles.addAll(user.getRoles());</span>
        }
<span class="nc" id="L77">        roles.add(userRole);</span>
<span class="nc" id="L78">        user.setRoles(roles);</span>

<span class="nc" id="L80">        UserResponse response = userMapper.toUserResponse(userRepository.save(user));</span>

<span class="nc" id="L82">        Set&lt;RoleResponse&gt; roleResponses = user.getRoles().stream()</span>
<span class="nc" id="L83">                .map(roleMapper::toRoleResponse).collect(Collectors.toSet());</span>
<span class="nc" id="L84">        response.setRoles(roleResponses);</span>

<span class="nc" id="L86">        emailService.sendUserEmailWithRegister(user);</span>

<span class="nc" id="L88">        return response;</span>
    }

    public IntrospectResponse introspect(TokenRequest request) throws JOSEException, ParseException {
<span class="nc" id="L92">        String token = request.getToken();</span>
<span class="nc" id="L93">        boolean inValid = true;</span>
        try {
<span class="nc" id="L95">            verifyToken(token);</span>
<span class="nc" id="L96">        } catch (SpotifyException e){</span>
<span class="nc" id="L97">            inValid = false;</span>
<span class="nc" id="L98">        }</span>
<span class="nc" id="L99">        return IntrospectResponse.builder()</span>
<span class="nc" id="L100">                .valid(inValid)</span>
<span class="nc" id="L101">                .build();</span>
    }

    public AuthResponse authenticated(AuthRequest request) throws JOSEException {
<span class="nc" id="L105">        User userDB = userRepository.findByEmail(request.getEmail())</span>
<span class="nc" id="L106">                .orElseThrow(()-&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>

<span class="nc" id="L108">        PasswordEncoder passwordEncoder  = new BCryptPasswordEncoder(10);</span>
<span class="nc" id="L109">        boolean isauthenticated = passwordEncoder.matches(request.getPassword(), userDB.getPassword());</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if(!isauthenticated){</span>
<span class="nc" id="L111">            throw new SpotifyException(ErrorCode.INVALID_PASSWORD);</span>
        }

<span class="nc" id="L114">        String token = generateToken(userDB);</span>

<span class="nc" id="L116">        return AuthResponse.builder()</span>
<span class="nc" id="L117">                .token(token)</span>
<span class="nc" id="L118">                .authenticaed(true)</span>
<span class="nc" id="L119">                .build();</span>
    }
    public String generateToken(User user) throws JOSEException {
        // header
<span class="nc" id="L123">        JWSHeader header = new JWSHeader(JWSAlgorithm.HS512);</span>

        // payload
<span class="nc" id="L126">        JWTClaimsSet jwtClaimsSet = new JWTClaimsSet.Builder()</span>
<span class="nc" id="L127">                .subject(user.getEmail())</span>
<span class="nc" id="L128">                .issuer(user.getName())</span>
<span class="nc" id="L129">                .issueTime(new Date())</span>
<span class="nc" id="L130">                .expirationTime(new Date(Instant.now().plus(tokenExpiration, ChronoUnit.DAYS).toEpochMilli()))</span>
<span class="nc" id="L131">                .claim(&quot;scope&quot;, buildScope(user))</span>
<span class="nc" id="L132">                .jwtID(UUID.randomUUID().toString())</span>
<span class="nc" id="L133">                .build();</span>
<span class="nc" id="L134">        Payload payload = new Payload(jwtClaimsSet.toJSONObject());</span>

<span class="nc" id="L136">        JWSObject jwsObject = new JWSObject(header,payload);</span>

<span class="nc" id="L138">        jwsObject.sign(new MACSigner(SINGER_KEY.getBytes()));</span>

<span class="nc" id="L140">        return jwsObject.serialize();</span>
    }

    public String buildScope(User user) {
<span class="nc" id="L144">        StringJoiner stringJoiner = new StringJoiner(&quot; &quot;);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if(!CollectionUtils.isEmpty(user.getRoles())){</span>
<span class="nc" id="L146">            user.getRoles().forEach(role -&gt; {stringJoiner.add(&quot;ROLE_&quot; + role.getName());</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                if(!CollectionUtils.isEmpty(role.getPermissions())){</span>
<span class="nc" id="L148">                    role.getPermissions().forEach(permission -&gt; {</span>
<span class="nc" id="L149">                        stringJoiner.add(permission.getName());</span>
<span class="nc" id="L150">                    });</span>
                }
<span class="nc" id="L152">            });</span>
        }
<span class="nc" id="L154">        return stringJoiner.toString();</span>
    }

    public void logout(TokenRequest request) throws ParseException, JOSEException {
<span class="nc" id="L158">        SignedJWT signToken = verifyToken(request.getToken());</span>
<span class="nc" id="L159">        String wti = signToken.getJWTClaimsSet().getJWTID();</span>
<span class="nc" id="L160">        Date expiryTime = signToken.getJWTClaimsSet().getExpirationTime();</span>

<span class="nc" id="L162">        InvalidatedToken invalidatedToken = InvalidatedToken.builder()</span>
<span class="nc" id="L163">                .id(wti)</span>
<span class="nc" id="L164">                .expiryTime(expiryTime)</span>
<span class="nc" id="L165">                .build();</span>

<span class="nc" id="L167">        invalidatedRepository.save(invalidatedToken);</span>
<span class="nc" id="L168">    }</span>
    private SignedJWT verifyToken(String token) throws JOSEException, ParseException {
<span class="nc" id="L170">        JWSVerifier verifier = new MACVerifier(SINGER_KEY.getBytes());</span>

<span class="nc" id="L172">        SignedJWT signedJWT = SignedJWT.parse(token);</span>

<span class="nc" id="L174">        Date expityTime = signedJWT.getJWTClaimsSet().getExpirationTime();</span>

<span class="nc" id="L176">        boolean isverifed = signedJWT.verify(verifier);</span>

<span class="nc" id="L178">        String jwtId = signedJWT.getJWTClaimsSet().getJWTID();</span>

<span class="nc bnc" id="L180" title="All 6 branches missed.">        if(!isverifed &amp;&amp; !expityTime.after(new Date()) || jwtId == null){</span>
<span class="nc" id="L181">            throw new SpotifyException(ErrorCode.UNAUTHENTICATED);</span>
        }

<span class="nc bnc" id="L184" title="All 2 branches missed.">        if(invalidatedRepository.existsById(jwtId)){</span>
<span class="nc" id="L185">            throw new SpotifyException(ErrorCode.UNAUTHORIZED);</span>
        }
<span class="nc" id="L187">        return signedJWT;</span>
    }
    public UserResponse getMyInfo() {
<span class="nc" id="L190">        var context = SecurityContextHolder.getContext();</span>
<span class="nc" id="L191">        String email = context.getAuthentication().getName();</span>

<span class="nc" id="L193">        User user = userRepository.findByEmail(email).orElseThrow(</span>
<span class="nc" id="L194">                () -&gt; new SpotifyException(ErrorCode.USER_NOT_EXISTED));</span>

<span class="nc" id="L196">        UserResponse response = userMapper.toUserResponse(userRepository.save(user));</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if(user.getCreatedPlaylists() != null){</span>
<span class="nc" id="L198">            Set&lt;PlaylistBasic&gt; playlistBasicSet = user.getCreatedPlaylists()</span>
<span class="nc" id="L199">                    .stream().map(playlistMapper::toPlaylistBasic).collect(Collectors.toSet());</span>
<span class="nc" id="L200">            response.setCreatedPlaylists(playlistBasicSet);</span>
        }
<span class="nc bnc" id="L202" title="All 4 branches missed.">        if(user.getRoles() != null &amp;&amp; !user.getRoles().isEmpty()){</span>
<span class="nc" id="L203">            Set&lt;RoleResponse&gt; roleResponses = user.getRoles().stream()</span>
<span class="nc" id="L204">                    .map(roleMapper::toRoleResponse).collect(Collectors.toSet());</span>
<span class="nc" id="L205">            response.setRoles(roleResponses);</span>
        }
<span class="nc" id="L207">        return response;</span>
    }

    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public StatsResponse getStatsCounts() {

<span class="nc" id="L213">        long totalUsers = userRepository.count();</span>

<span class="nc" id="L215">        long totalAlbums = albumRepository.count();</span>

<span class="nc" id="L217">        long totalArtists = artistRepository.count();</span>

<span class="nc" id="L219">        long totalSongs = songRepository.count();</span>

<span class="nc" id="L221">        long totalPlaylists = playlistRepository.count();</span>

<span class="nc" id="L223">        return StatsResponse.builder()</span>
<span class="nc" id="L224">                .totalUsers(totalUsers)</span>
<span class="nc" id="L225">                .totalAlbums(totalAlbums)</span>
<span class="nc" id="L226">                .totalArtists(totalArtists)</span>
<span class="nc" id="L227">                .totalPlaylists(totalPlaylists)</span>
<span class="nc" id="L228">                .totalSongs(totalSongs)</span>
<span class="nc" id="L229">                .build();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>
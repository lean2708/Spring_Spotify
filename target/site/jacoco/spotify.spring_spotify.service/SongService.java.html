<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SongService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring_spotify</a> &gt; <a href="index.source.html" class="el_package">spotify.spring_spotify.service</a> &gt; <span class="el_source">SongService.java</span></div><h1>SongService.java</h1><pre class="source lang-java linenums">package spotify.spring_spotify.service;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.xml.sax.SAXException;
import spotify.spring_spotify.dto.basic.ArtistBasic;
import spotify.spring_spotify.dto.request.SongRequest;
import spotify.spring_spotify.dto.response.PageResponse;
import spotify.spring_spotify.dto.response.SongResponse;
import spotify.spring_spotify.entity.*;
import spotify.spring_spotify.exception.ErrorCode;
import spotify.spring_spotify.exception.FileException;
import spotify.spring_spotify.exception.SpotifyException;
import spotify.spring_spotify.mapper.AlbumMapper;
import spotify.spring_spotify.mapper.ArtistMapper;
import spotify.spring_spotify.mapper.SongMapper;
import spotify.spring_spotify.repository.AlbumRepository;
import spotify.spring_spotify.repository.ArtistRepository;
import spotify.spring_spotify.repository.GenreRepository;
import spotify.spring_spotify.repository.SongRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import spotify.spring_spotify.specification.SongSpecification;

import java.io.IOException;
import java.util.*;

@RequiredArgsConstructor
@Service
public class SongService {
    private final SongRepository songRepository;
    private final AlbumRepository albumRepository;
    private final ArtistRepository artistRepository;
    private final GenreRepository genreRepository;
    private final ArtistMapper artistMapper;
    private final FileService fileService;
    private final AlbumMapper albumMapper;
    private final SongMapper songMapper;

    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public SongResponse create(SongRequest request, MultipartFile image, MultipartFile fileSong) throws FileException, IOException,  SAXException {
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if(songRepository.existsByName(request.getName())){</span>
<span class="nc" id="L49">            throw new SpotifyException(ErrorCode.SONG_EXISTED);</span>
        }
<span class="nc" id="L51">       Song song = songMapper.toSong(request);</span>

<span class="nc" id="L53">        Set&lt;Song&gt; songSet = new HashSet&lt;&gt;();</span>
<span class="nc" id="L54">        songSet.add(song);</span>

        // Album
<span class="nc bnc" id="L57" title="All 4 branches missed.">        if(request.getAlbum() != null &amp;&amp; !request.getAlbum().isEmpty()){</span>
<span class="nc" id="L58">           Album album = albumRepository.findByName(request.getAlbum());</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">           if(album != null){</span>
<span class="nc" id="L60">               song.setAlbum(album);</span>
<span class="nc" id="L61">               album.setSongs(songSet);</span>
<span class="nc" id="L62">               album.setTotalTracks(album.getTotalTracks() + 1);</span>
<span class="nc" id="L63">               album.setTotalHours(album.getTotalHours() + song.getDuration());</span>
           }
        }
        // Artist
<span class="nc bnc" id="L67" title="All 4 branches missed.">        if(request.getArtists() != null &amp;&amp; !request.getArtists().isEmpty()){</span>
<span class="nc" id="L68">            List&lt;Artist&gt; artistList = artistRepository</span>
<span class="nc" id="L69">                    .findAllByNameIn(new ArrayList&lt;&gt;(request.getArtists()));</span>
<span class="nc" id="L70">                song.setArtists(new HashSet&lt;&gt;(artistList));</span>
<span class="nc" id="L71">        }else{</span>
<span class="nc" id="L72">            song.setArtists(new HashSet&lt;&gt;());</span>
        }

        // Genre
<span class="nc bnc" id="L76" title="All 4 branches missed.">        if(request.getGenre() != null &amp;&amp; !request.getGenre().isEmpty()){</span>
<span class="nc" id="L77">            Genre genre = genreRepository.findByName(request.getGenre());</span>
<span class="nc" id="L78">            song.setGenre(genre);</span>
        }

<span class="nc" id="L81">        song.setListener(song.getListener() + 1);</span>

        // Image
<span class="nc bnc" id="L84" title="All 4 branches missed.">        if (image != null &amp;&amp; !image.isEmpty()) {</span>
<span class="nc" id="L85">            List&lt;String&gt; allowedFileImageExtensions = new ArrayList&lt;&gt;</span>
<span class="nc" id="L86">                    (Arrays.asList(&quot;jpg&quot;, &quot;jpeg&quot;, &quot;png&quot;, &quot;gif&quot;, &quot;bmp&quot;, &quot;svg&quot;));</span>
<span class="nc" id="L87">            song.setImageURL(fileService.uploadFile(image, allowedFileImageExtensions).getUrl());</span>
        }

        // File song
<span class="nc bnc" id="L91" title="All 4 branches missed.">        if (fileSong != null &amp;&amp; !fileSong.isEmpty()) {</span>
<span class="nc" id="L92">            List&lt;String&gt; allowedFileSongExtensions = new ArrayList&lt;&gt;</span>
<span class="nc" id="L93">                    (Arrays.asList(&quot;mp3&quot;, &quot;wav&quot;, &quot;aac&quot;, &quot;flac&quot;, &quot;ogg&quot;, &quot;avi&quot;, &quot;mov&quot;, &quot;mkv&quot;, &quot;flv&quot;, &quot;wmv&quot;, &quot;m4a&quot;));</span>
<span class="nc" id="L94">            song.setFileSongURL(fileService.uploadFile(fileSong, allowedFileSongExtensions).getUrl());</span>
        }

<span class="nc" id="L97">       return convertSongResponse(songRepository.save(song));</span>
    }

    public SongResponse fetchById(long id){
<span class="nc" id="L101">        Song song = songRepository.findById(id)</span>
<span class="nc" id="L102">                .orElseThrow(() -&gt; new SpotifyException(ErrorCode.SONG_NOT_EXISTED));</span>

<span class="nc" id="L104">        song.setListener(song.getListener() + 1);</span>

<span class="nc" id="L106">        return convertSongResponse(song);</span>
    }

    public PageResponse&lt;SongResponse&gt; fetchAllSong( int pageNo,int pageSize, String nameSortOrder){
<span class="nc" id="L110">        pageNo = pageNo - 1;</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">        Sort sort = (nameSortOrder.equalsIgnoreCase(&quot;asc&quot;))</span>
<span class="nc" id="L113">                ? Sort.by(Sort.Order.asc(&quot;name&quot;))</span>
<span class="nc" id="L114">                : Sort.by(Sort.Order.desc(&quot;name&quot;));</span>

<span class="nc" id="L116">        Pageable pageable = PageRequest.of(pageNo, pageSize, sort);</span>

<span class="nc" id="L118">        Page&lt;Song&gt; songPage = songRepository.findAll(pageable);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (songPage.isEmpty()) {</span>
<span class="nc" id="L120">            throw new SpotifyException(ErrorCode.SONG_NOT_FOUND);</span>
        }

<span class="nc" id="L123">        List&lt;SongResponse&gt; responses = convertListSongResponse(songPage.getContent());</span>

<span class="nc" id="L125">        return PageResponse.&lt;SongResponse&gt;builder()</span>
<span class="nc" id="L126">                .page(songPage.getNumber() + 1)  // Thêm 1 để bắt đầu từ trang 1</span>
<span class="nc" id="L127">                .size(songPage.getSize())</span>
<span class="nc" id="L128">                .totalPages(songPage.getTotalPages())</span>
<span class="nc" id="L129">                .totalItems(songPage.getTotalElements())</span>
<span class="nc" id="L130">                .items(responses)</span>
<span class="nc" id="L131">                .build();</span>
    }

    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public SongResponse update(long id, SongRequest request,
                               MultipartFile image, MultipartFile fileSong) throws FileException, IOException,  SAXException {
<span class="nc" id="L137">        Song songDB = songRepository.findById(id)</span>
<span class="nc" id="L138">                .orElseThrow(() -&gt; new SpotifyException(ErrorCode.SONG_NOT_EXISTED));</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">        if(songDB.getAlbum() != null) {</span>
<span class="nc" id="L141">            songDB.getAlbum().setTotalHours(songDB.getAlbum().getTotalHours() - songDB.getDuration());</span>
        }

<span class="nc" id="L144">        Song song = songMapper.update(songDB, request);</span>
<span class="nc" id="L145">        Set&lt;Song&gt; songSet = new HashSet&lt;&gt;();</span>
<span class="nc" id="L146">        songSet.add(song);</span>
        // Album
<span class="nc bnc" id="L148" title="All 4 branches missed.">        if(request.getAlbum() != null &amp;&amp; !request.getAlbum().isEmpty()){</span>
<span class="nc" id="L149">            Album album = albumRepository.findByName(request.getAlbum());</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if(album != null){</span>
<span class="nc" id="L151">                song.setAlbum(album);</span>
<span class="nc" id="L152">                album.setSongs(songSet);</span>
<span class="nc" id="L153">                album.setTotalHours(album.getTotalHours() + song.getDuration()/3600);</span>
            }
        }

        // Artist
<span class="nc bnc" id="L158" title="All 4 branches missed.">        if(request.getArtists() != null &amp;&amp; !request.getArtists().isEmpty()){</span>
<span class="nc" id="L159">            List&lt;Artist&gt; artistList = artistRepository</span>
<span class="nc" id="L160">                    .findAllByNameIn(new ArrayList&lt;&gt;(request.getArtists()));</span>
<span class="nc" id="L161">            song.setArtists(new HashSet&lt;&gt;(artistList));</span>
<span class="nc" id="L162">        }else{</span>
<span class="nc" id="L163">            song.setArtists(new HashSet&lt;&gt;());</span>
        }

        // Genre
<span class="nc bnc" id="L167" title="All 4 branches missed.">        if(request.getGenre() != null &amp;&amp; !request.getGenre().isEmpty()){</span>
<span class="nc" id="L168">            Genre genre = genreRepository.findByName(request.getGenre());</span>
<span class="nc" id="L169">            song.setGenre(genre);</span>
        }

<span class="nc" id="L172">        song.setListener(song.getListener() + 1);</span>

        // Image
<span class="nc bnc" id="L175" title="All 4 branches missed.">        if (image != null &amp;&amp; !image.isEmpty()) {</span>
<span class="nc" id="L176">            List&lt;String&gt; allowedFileImageExtensions = new ArrayList&lt;&gt;</span>
<span class="nc" id="L177">                    (Arrays.asList(&quot;jpg&quot;, &quot;jpeg&quot;, &quot;png&quot;, &quot;gif&quot;, &quot;bmp&quot;, &quot;svg&quot;));</span>
<span class="nc" id="L178">            song.setImageURL(fileService.uploadFile(image, allowedFileImageExtensions).getUrl());</span>
        }

        // File song
<span class="nc bnc" id="L182" title="All 4 branches missed.">         if (fileSong != null &amp;&amp; !fileSong.isEmpty()) {</span>
<span class="nc" id="L183">             List&lt;String&gt; allowedFileSongExtensions = new ArrayList&lt;&gt;</span>
<span class="nc" id="L184">                     (Arrays.asList(&quot;mp3&quot;, &quot;wav&quot;, &quot;aac&quot;, &quot;flac&quot;, &quot;ogg&quot;, &quot;avi&quot;, &quot;mov&quot;, &quot;mkv&quot;, &quot;flv&quot;, &quot;wmv&quot;));</span>
<span class="nc" id="L185">             song.setFileSongURL(fileService.uploadFile(fileSong, allowedFileSongExtensions).getUrl());</span>
         }

<span class="nc" id="L188">        return songMapper.toSongResponse(songRepository.save(song));</span>
    }

    public PageResponse&lt;SongResponse&gt; searchSongs(String name, int pageNo, int pageSize){
<span class="nc" id="L192">        pageNo = pageNo - 1;</span>

<span class="nc" id="L194">        Pageable pageable = PageRequest.of(pageNo, pageSize);</span>

<span class="nc" id="L196">        Specification&lt;Song&gt; spec = Specification.where(SongSpecification.hasNameContainingIgnoreCase(name))</span>
<span class="nc" id="L197">                .and(SongSpecification.sortByNamePriority(name));</span>

<span class="nc" id="L199">        Page&lt;Song&gt; songPage = songRepository.findAll(spec, pageable);</span>

<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (songPage.isEmpty()) {</span>
<span class="nc" id="L202">            throw new SpotifyException(ErrorCode.SONG_NOT_EXISTED);</span>
        }

        // convert
<span class="nc" id="L206">        List&lt;SongResponse&gt; playlistResponses = convertListSongResponse(songPage.getContent());</span>

<span class="nc" id="L208">        return PageResponse.&lt;SongResponse&gt;builder()</span>
<span class="nc" id="L209">                .page(songPage.getNumber() + 1)  // Thêm 1 để bắt đầu từ trang 1</span>
<span class="nc" id="L210">                .size(songPage.getSize())</span>
<span class="nc" id="L211">                .totalPages(songPage.getTotalPages())</span>
<span class="nc" id="L212">                .totalItems(songPage.getTotalElements())</span>
<span class="nc" id="L213">                .items(playlistResponses)</span>
<span class="nc" id="L214">                .build();</span>
    }

    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public void delete(long id){
<span class="nc" id="L219">        Song songDB = songRepository.findById(id)</span>
<span class="nc" id="L220">                .orElseThrow(() -&gt; new SpotifyException(ErrorCode.SONG_NOT_EXISTED));</span>

<span class="nc" id="L222">        songRepository.delete(songDB);</span>
<span class="nc" id="L223">    }</span>

    public SongResponse convertSongResponse(Song song){
<span class="nc" id="L226">        SongResponse response = songMapper.toSongResponse(songRepository.save(song));</span>

<span class="nc" id="L228">        response.setAlbum(Optional.ofNullable(song.getAlbum())</span>
<span class="nc" id="L229">                .map(albumMapper::toAlbumBasic).orElse(null));</span>

<span class="nc" id="L231">        List&lt;ArtistBasic&gt; artistBasicList = song.getArtists()</span>
<span class="nc" id="L232">                .stream().map(artistMapper::toArtistBasic).toList();</span>
<span class="nc" id="L233">        response.setArtists(new HashSet&lt;&gt;(artistBasicList));</span>

<span class="nc" id="L235">        return response;</span>
    }

    public List&lt;SongResponse&gt; convertListSongResponse(List&lt;Song&gt; songList){
<span class="nc" id="L239">        List&lt;SongResponse&gt; songResponseList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        for(Song song : songList){</span>
<span class="nc" id="L241">            SongResponse response = convertSongResponse(song);</span>
<span class="nc" id="L242">            songResponseList.add(response);</span>
<span class="nc" id="L243">        }</span>
<span class="nc" id="L244">        return songResponseList;</span>
    }
    public PageResponse&lt;SongResponse&gt; fetchAllSongSortedByViewer( int pageNo, int pageSize, String viewerSortOrder) {
<span class="nc" id="L247">        pageNo = pageNo - 1;</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">        Sort sort = (viewerSortOrder.equalsIgnoreCase(&quot;asc&quot;))</span>
<span class="nc" id="L250">                ? Sort.by(Sort.Order.asc(&quot;listener&quot;))</span>
<span class="nc" id="L251">                : Sort.by(Sort.Order.desc(&quot;listener&quot;));</span>

<span class="nc" id="L253">        Pageable pageable = PageRequest.of(pageNo, pageSize, sort);</span>

<span class="nc" id="L255">        Page&lt;Song&gt; songPage = songRepository.findAll(pageable);</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (songPage.isEmpty()) {</span>
<span class="nc" id="L258">            throw new SpotifyException(ErrorCode.SONG_NOT_EXISTED);</span>
        }

<span class="nc" id="L261">        List&lt;SongResponse&gt; playlistResponses = convertListSongResponse(songPage.getContent());</span>

<span class="nc" id="L263">        return PageResponse.&lt;SongResponse&gt;builder()</span>
<span class="nc" id="L264">                .page(songPage.getNumber() + 1)  // Thêm 1 để bắt đầu từ trang 1</span>
<span class="nc" id="L265">                .size(songPage.getSize())</span>
<span class="nc" id="L266">                .totalPages(songPage.getTotalPages())</span>
<span class="nc" id="L267">                .totalItems(songPage.getTotalElements())</span>
<span class="nc" id="L268">                .items(playlistResponses)</span>
<span class="nc" id="L269">                .build();</span>
    }

    public List&lt;SongResponse&gt; fetchSongsByGenre(long genreId) {
<span class="nc" id="L273">        Genre genre = genreRepository.findById(genreId)</span>
<span class="nc" id="L274">                .orElseThrow(() -&gt; new SpotifyException(ErrorCode.GENRE_NOT_EXISTED));</span>
<span class="nc" id="L275">        List&lt;Song&gt; songList = songRepository.findAllByGenre(genre);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (songList.isEmpty()) {</span>
<span class="nc" id="L277">            throw new SpotifyException(ErrorCode.SONG_NOT_FOUND_FOR_GENRE);</span>
        }

<span class="nc" id="L280">        return convertListSongResponse(songList);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>